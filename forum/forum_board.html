<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Раздел | Youvi Forums</title>
<link rel="stylesheet" href="forum-dark-theme.css">
<link rel="stylesheet" href="../youvi/header/youvi-header.css">
<link rel="stylesheet" href="../youvi/sidebar-scroll.css">
<link rel="stylesheet" href="../youvi/sidebar.css">
<link rel="stylesheet" href="../youvi/themes/theme-dropdown.css">
<script>
  (function() {
    var theme = localStorage.getItem('youvi-theme');
    var sidebar = localStorage.getItem('sidebarCollapsed');
    
    var htmlClasses = [];
    if (theme === 'dark') htmlClasses.push('dark-theme');
    if (sidebar === 'true') htmlClasses.push('sidebar-collapsed');
    if (htmlClasses.length) document.documentElement.className = htmlClasses.join(' ');
  })();
</script>
<style>
@font-face{font-family:'VAG Rounded';src:url('../fonts/vagroundcyrillic.ttf') format('truetype');font-weight:normal;font-style:normal}
*{margin:0;padding:0;box-sizing:border-box}
body {
    font-family: Arial, sans-serif;
    background: #fff;
    color: #111;
    --header-height: 84px;
    --footer-height: 220px;
}

body.custom-background {
    background: none !important;
}

body.custom-background::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: var(--bg-image);
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    background-attachment: fixed;
    z-index: -1;
}
.top-nav{background:#d94b88;border-bottom:1px solid #c2185b;padding:4px 0}
.top-nav-content{max-width:none !important;margin:0 !important;padding:0 20px;display:flex;gap:20px;align-items:center}
.top-nav a{color:#fff;text-decoration:none;font-size:12px;padding:2px 0;transition:color .2s}
.top-nav a:hover,.top-nav a.active{color:#ffd6ea}
.header{background:#FFE7F4;padding:0;border-bottom:1px solid #f2cfe1;min-height:40px;width:100%;position:sticky;top:0;z-index:100}
.header-content-wrapper{display:flex;align-items:center;position:relative;box-sizing:border-box;max-width:none !important;margin:0 !important;padding:0 20px;width:100%;min-height:40px}
.header-left{display:flex;align-items:center;gap:15px;flex-shrink:0}
.header-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;z-index:1}
.header-right{display:flex;align-items:center;gap:10px;margin-left:auto;flex-shrink:0}
.search-area{display:flex;gap:6px;align-items:center;width:530px;position:relative}
.search-input{width:450px;padding:6px 12px;border-radius:4px;border:1px solid rgba(0,0,0,0.1);font-size:13px;height:32px;box-sizing:border-box}
.search-btn{width:70px;height:32px;padding:0;background:#ff69b4;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;display:flex;align-items:center;justify-content:center;text-align:center;line-height:1;flex-shrink:0;white-space:nowrap;box-sizing:border-box;transition:background-color .2s}
.search-btn:hover{background:#ff85c3}
.container{width:100%;margin:0;padding:0 20px 0 20px;display:flex;gap:20px;align-items:stretch;min-height:calc(100vh - 40px - 40px)}
.content-wrapper{display:flex;flex:1;max-width:1500px;margin:0 auto;gap:20px;background:#fff}
body.dark-theme .content-wrapper{background:#111}
body.dark-theme.custom-background .content-wrapper{background:#111}
body.custom-background .content-wrapper{background:rgba(255,255,255,0.95)}
.main-content{flex:1;display:flex;flex-direction:column;min-height:0;padding-top:0}
.user-actions{display:flex;gap:8px;align-items:center;margin-left:0;flex-shrink:0}
.user-actions a{color:#111;text-decoration:none;font-size:13px;font-weight:500;padding:4px 8px;border-radius:4px;transition:background .2s}
.user-actions a:hover{color:#ff69b4}
.logo{display:flex;align-items:center;justify-content:center;margin-right:0;flex-shrink:0;height:40px}
.logo img{height:30px;width:auto;max-height:30px}
/* Removed - using standard 20px margins like forum_main */
.breadcrumbs{display:flex;align-items:center;gap:4px;font-size:13px;color:#666;margin-top:20px;margin-bottom:10px;flex-wrap:wrap}
.breadcrumbs a{color:#666;text-decoration:none;transition:color .2s}
.breadcrumbs a:hover{color:#ff69b4}
.breadcrumb-separator{color:#999}
.banner-section{background:center/cover no-repeat;margin:0 20px 5px 20px;overflow:hidden;height:175px;position:relative;display:flex;align-items:center;justify-content:space-between;padding-left:40px;padding-right:40px}
.banner-section .board-name-overlay{font-family:'VAG Rounded','Comic Sans MS',sans-serif;font-size:80px;font-weight:bold;color:#d90f7b;z-index:1}
.banner-section .board-logo{height:150px;width:auto;z-index:1}
.management-section{margin:0 20px 3px 20px;border-bottom:2px solid #ff69b4;padding-bottom:5px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.section-title{font-size:20px;color:#111;margin:0}
/* Sidebar offset for sticky header */
.sidebar:not(.chats-sidebar) {
    top: 40px !important;
    max-height: calc(100vh - 40px) !important;
    min-height: calc(100vh - 40px) !important;
}
.footer{background:#2c2c2c;color:#fff;padding:25px 0 15px 0;margin-top:auto}
.footer-content{max-width:1400px !important;margin:0 auto !important;padding:0 20px !important;display:flex;gap:30px;align-items:flex-start}
.footer-main{display:flex;gap:30px;flex:1}
.footer-logo{flex-shrink:0;width:200px}
.footer-logo img{height:40px;width:auto}
.footer-logo p{margin-top:8px;font-size:11px;color:#ccc;line-height:1.3}
.footer-sections{display:flex;gap:30px;flex:1}
.footer-right{display:flex;gap:20px;align-items:flex-start}
.footer-mascot{flex-shrink:0}
.footer-mascot img{height:180px;width:auto}
.footer-section{flex:1}
.footer-section h3{font-size:13px;margin-bottom:10px;color:#fff;font-weight:600}
.footer-section ul{list-style:none;padding:0;margin:0}
.footer-section li{margin-bottom:6px}
.footer-section a{color:#ccc;text-decoration:none;font-size:11px;transition:color .2s}
.footer-section a:hover{color:#ff69b4}
.footer-bottom{border-top:1px solid #444;margin-top:20px;padding-top:15px;text-align:center;color:#999;font-size:10px}
@media (max-width:768px){.container{flex-direction:column;padding:10px}.footer-content{flex-direction:column;gap:20px}.footer-sections{flex-direction:column;gap:15px}.footer-section{text-align:center}}
/* PC Adaptive Styling */
@media (min-width: 1700px) {
    .content-wrapper{max-width:1600px}
    .footer-content{max-width:1700px !important}
    .banner-section{height:250px !important}
}
@media (min-width: 2000px) {
    .content-wrapper{max-width:1850px}
    .footer-content{max-width:1900px !important}
    .banner-section{height:280px !important}
}
@media (min-width: 2400px) {
    .content-wrapper{max-width:2200px}
    .footer-content{max-width:2200px !important}
    .banner-section{height:300px !important}
}
@media (min-width: 2800px) {
    .content-wrapper{max-width:2500px}
    .footer-content{max-width:2500px !important}
    .banner-section{height:320px !important}
}
/* Sidebar collapsed adaptations */
@media (min-width: 1700px) {
    .sidebar-collapsed .content-wrapper,
    html.sidebar-collapsed .content-wrapper {
        max-width: 1700px !important;
    }
}
@media (min-width: 2000px) {
    .sidebar-collapsed .content-wrapper,
    html.sidebar-collapsed .content-wrapper {
        max-width: 1950px !important;
    }
}
@media (min-width: 2400px) {
    .sidebar-collapsed .content-wrapper,
    html.sidebar-collapsed .content-wrapper {
        max-width: 2300px !important;
    }
}
@media (min-width: 2800px) {
    .sidebar-collapsed .content-wrapper,
    html.sidebar-collapsed .content-wrapper {
        max-width: 2600px !important;
    }
}
/* Dark theme additions */
body.dark-theme .header {
    background: #2c1810 !important;
    border-bottom: 1px solid #444 !important;
}
body.dark-theme .sidebar-toggle-btn {
    color: #fff !important;
}
body.dark-theme .sidebar-toggle-btn svg {
    fill: #fff !important;
}
body.dark-theme .user-actions a {
    color: #fff !important;
}
body.dark-theme .user-actions a:hover {
    color: #ff69b4 !important;
}
body.dark-theme .search-input {
    background: #4a3a34 !important;
    border-color: #555;
    color: #fff;
}
body.dark-theme .search-input::placeholder {
    color: #999;
}

/* Threads list styled identically to forum_main boards list */
.thread-list{background:#fafafa}
.boards-header{display:grid;grid-template-columns:1fr 120px 280px 80px;gap:0;background:#f0f0f0;color:#666;font-size:12px;padding:8px 16px;border-bottom:1px solid #e0e0e0}
.boards-header div:nth-child(2){text-align:center}
.board-item{display:grid;grid-template-columns:1fr 120px 280px 80px;gap:0;align-items:center;padding:8px 16px;border-bottom:1px solid #e8e8e8;transition:background-color .15s;text-decoration:none;color:inherit}
.board-item:last-child{border-bottom:none}
.board-item:hover{background:#f0f0f0}
.board-item.pinned{outline:2px solid #ff69b4;outline-offset:-2px}
body.dark-theme .board-item.pinned{background:rgba(255,105,180,0.1)}
.board-info{display:flex;gap:14px;align-items:center;min-width:0;overflow:hidden}
.board-info > div{min-width:0;overflow:hidden}
.board-title{font-size:15px;font-weight:500;color:#111;margin-bottom:2px;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.board-description{font-size:12px;color:#666;line-height:1.3}
.board-description a{color:#ff69b4;text-decoration:none;transition:color .2s}
.board-description a:hover{color:#e91e63}
.posts-stats{font-size:13px;color:#333;text-align:center}
.last-post{font-size:12px;color:#666;line-height:1.2;overflow:hidden}
.last-post-title{display:-webkit-box;-webkit-line-clamp:2;line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;word-break:break-word;overflow-wrap:anywhere;margin-bottom:2px}
.last-post-title a{color:inherit;text-decoration:none;transition:color .2s}
.last-post-title a:hover{color:#ff69b4}
.last-post-author{color:#888}
.last-post-author a{color:#ff69b4;text-decoration:none;transition:color .2s}
.last-post-author a:hover{color:#e91e63}
.last-post-time{color:#999}
.thread-link{color:#111;text-decoration:none}
.thread-link:hover{color:#c2185b;text-decoration:underline}
.create-thread{background:#fff;padding:12px;border:1px solid #e0e0e0;border-radius:8px;margin:0 8px 12px 8px}
.form-row{margin-bottom:8px}
.form-row label{display:block;font-size:12px;font-weight:700;margin-bottom:4px}
.form-row input,.form-row textarea{width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:12px}
.form-row textarea{min-height:60px;resize:vertical}
.form-controls{display:flex;justify-content:space-between;align-items:center}
.btn{padding:6px 10px;border-radius:0;background:#fff;border:1px solid #e0e0e0;cursor:pointer;font-weight:700;text-decoration:none;color:#111;display:inline-block;font-size:12px}
.btn.primary{background:#ff69b4;color:#fff;border-color:#ff69b4}
.small-btn{font-size:11px;padding:3px 6px;margin-left:6px;border-radius:0}
/* Create thread panel (compact, gray, collapsible) */
.thread-create-panel{background:#fafafa;border:1px solid #e6e6e6;border-radius:0;padding:0;margin:0 20px 12px 20px;overflow:hidden;transition:max-height .2s ease}
.thread-create-header{display:none}
.thread-create-body{display:grid;grid-template-columns:auto 1fr;gap:8px;padding:8px 10px}
.thread-create-panel.collapsed .thread-create-body{display:none}
.thread-create-row{display:flex;gap:6px;align-items:center;flex-wrap:nowrap}
.thread-create-row label{font-size:12px;color:#444}
.thread-create-row input,.thread-create-row textarea{padding:4px 6px;border:1px solid #ddd;border-radius:4px;font-size:12px}
/* Make text inputs flexible; keep nick compact */
.thread-create-row input[type="text"]{flex:1;min-width:0}
#nickInput{flex:0 0 220px;max-width:260px}
/* Message row stacked */
.thread-create-row.message-row{flex-direction:column;align-items:stretch}
.thread-create-row.message-row label{margin-bottom:4px}
.thread-create-actions{display:flex;gap:8px;margin-left:auto}

  /* Small popover for board settings */
  #boardSettingsPopover{position:fixed;display:none;z-index:10000;background:#fff;border:1px solid #e6e6e6;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);font-family:Arial, sans-serif;overflow:hidden}
  #boardSettingsPopover, #boardSettingsPopover *{font-weight:400 !important}
  #boardSettingsPopover .pop-header{padding:2px 8px;background:#ffe7f4;border-bottom:1px solid #f2cfe1;font-size:11px;display:flex;align-items:center;justify-content:space-between;line-height:1.2}
  #boardSettingsPopover .pop-body{padding:8px;display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center}
  /* Pagination styles (aligned with photos.html) */
  .pagination{margin-top:12px;padding:12px 0;display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;color:#111}
  .pagination-info{font-size:12px;color:#666;margin-right:10px}
  .pagination-btn{min-width:30px;padding:4px 8px;margin:1px;border-radius:4px;cursor:pointer;transition:all .1s;background:#ff69b4;color:#fff;border:none;font-size:12px}
  .pagination-btn.active{background:#d94b88;color:#fff;font-weight:bold}
  .pagination-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;background:#e0e0e0;color:#777}
  
  /* Loading states */
  .loading-skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite}
  @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .thread-skeleton{height:60px;margin:8px 16px;border-radius:4px}
  .loading-indicator{display:flex;align-items:center;justify-content:center;padding:20px;color:#666;font-size:14px}
  .loading-spinner{width:20px;height:20px;border:2px solid #f3f3f3;border-top:2px solid #ff69b4;border-radius:50%;animation:spin 1s linear infinite;margin-right:10px}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>
<link rel="icon" href="../favicon/youvi/favicon.ico" type="image/x-icon">
<body>
<script src="../youvi_shared.js"></script>
<script src="forum_youvi_integration.js"></script>
<script src="../youvi/themes/theme-toggle.js"></script>
  <div class="top-nav">
    <div class="top-nav-content">
      <a href="../youvi_main.html">Видео</a>
      <a href="../index.html">Управление</a>
      <a href="../youvi_ch_list.html">Каналы</a>
      <a href="../youvi_playlists_list.html">Плейлисты</a>
      <a href="forum.html" class="active">Форумы</a>
      <a href="../wiki/index.html" data-i18n="nav.wiki">Wiki</a>
    </div>
  </div>

  <header class="header">
    <div class="header-content-wrapper">
      <div class="header-left">
        <button id="sidebarToggle" class="sidebar-toggle-btn" aria-label="Toggle sidebar">
          <svg viewBox="0 0 24 24">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </button>
        
        <div class="logo">
          <a href="forum.html"><img src="../images/logo_youvi_ind.png" alt="Forum Logo"></a>
        </div>
      </div>
      
      <div class="header-center">
        <div class="search-area">
          <input type="text" class="search-input" id="forumHeaderSearchInput" placeholder="Поиск в форуме...">
          <button class="search-btn" id="forumHeaderSearchBtn">Поиск</button>
        </div>
      </div>
      
      <div class="header-right">
        <div class="user-actions">
          <div class="settings-container">
            <a href="#" class="settings-btn">⚙</a>
            <div class="theme-dropdown">
              <button class="theme-dropdown-item" data-theme="light">Белая</button>
              <button class="theme-dropdown-item" data-theme="dark">Черная</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">Навигация</div>
        <a href="../youvi_main.html" class="sidebar-item nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9,22 9,12 15,12 15,22"/>
          </svg>
          <span>Главная</span>
        </a>
        <a href="../youvi_tags.html" class="sidebar-item nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
            <line x1="7" y1="7" x2="7.01" y2="7"/>
          </svg>
          <span>Все теги</span>
        </a>
      </div>
      
      
      <div class="sidebar-section">
        <div class="sidebar-title">Форум</div>
        <a href="forum.html" class="sidebar-item nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <span>Главная</span>
        </a>
        <a href="forum_recent.html" class="sidebar-item nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
            <path d="M4 11a9 9 0 0 1 9 9"/>
            <path d="M4 4a16 16 0 0 1 16 16"/>
            <path d="M5 20a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
          </svg>
          <span>Поток</span>
        </a>
        <a href="forum_search.html" class="sidebar-item nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <span>Поиск</span>
        </a>
        <a href="forum_fav.html" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
          <span>Избранное</span>
        </a>
        <a href="forum_members.html" class="sidebar-item library-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 1-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <span>Участники</span>
        </a>

      </div>
    </aside>

    <!-- Content Wrapper (centered) -->
    <div class="content-wrapper">
    <main class="main-content">
      <div id="topForumContainer">
        <section class="banner-section" id="forumBannerSection"></section>
        <section class="management-section" id="forumManagementSection">
          <div class="section-title" id="boardTitle">Раздел</div>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <a href="forum.html" class="btn">← К форуму</a>
            <button id="toggleCreateThread" class="btn" aria-expanded="false" aria-controls="createThreadPanel">Новая тема ▸</button>
            <button id="openBoardSettings" class="btn">Фон раздела</button>
          </div>
        </section>
        <div class="breadcrumbs" style="margin:0 20px 10px 20px">
          <a href="forum_main.html">Форум</a>
          <span class="breadcrumb-separator">→</span>
          <span id="boardBreadcrumb" style="font-weight:600">Раздел</span>
        </div>
        <div style="margin:0 20px;color:#666;font-size:12px" id="boardInfo" class="thread-meta"></div>
      </div>

      <div class="thread-create-panel" id="createThreadPanel" aria-label="Новая тема">
        <div class="thread-create-header">
          <div class="section-title" style="font-size:13px">Новая тема</div>
        </div>
        <div class="thread-create-body">
          <div class="thread-create-row">
    <label>Ник:</label>
            <input id="nickInput" type="text" placeholder="Аноним">
  </div>
          <div class="thread-create-row">
    <label>Заголовок:</label>
    <input id="titleInput" type="text" placeholder="Заголовок темы">
  </div>
          <div class="thread-create-row message-row" style="grid-column:1/-1">
    <label>Сообщение:</label>
            <textarea id="messageInput" placeholder="Первое сообщение в теме" style="width:100%;min-height:60px;resize:vertical"></textarea>
  </div>
          <div class="thread-create-row" style="grid-column:1/-1;justify-content:space-between">
    <input type="file" id="imageInput" accept="image/*">
            <div class="thread-create-actions">
              <button class="btn" id="resetCreate">Сбросить</button>
    <button id="createThread" class="btn primary">Создать тему</button>
            </div>
          </div>
  </div>
</div>

      <section style="margin:0 20px 12px 20px;background:#fff;border:none;border-radius:0;padding:0;">
  <div class="thread-list">
    <div class="boards-header">
      <div>Тема</div>
      <div>Сообщения</div>
      <div>Последнее сообщение</div>
      <div style="text-align:center">Действия</div>
    </div>
    <div id="threadsList"><div style="padding:14px 16px;color:#666;text-align:center">Загрузка...</div></div>
  </div>
</section>
    </main>
    </div><!-- /content-wrapper -->
</div>
<!-- Small popover anchored to the settings button -->
<div id="boardSettingsPopover" role="dialog" aria-label="Фон раздела">
  <div class="pop-header">
    <span>Фон раздела</span>
    <button id="closeBoardSettings" class="btn" style="font-size:12px">✕</button>
  </div>
  <div class="pop-body">
    <div>
      <div style="font-size:12px;font-weight:700;margin-bottom:4px;">Изображение</div>
      <input id="boardBgFile" type="file" accept="image/*">
      <div style="font-size:11px;color:#888;margin-top:4px">Сохранится в assets/ текущего раздела</div>
    </div>
    <div style="display:flex;gap:6px;align-items:center;">
      <button id="toggleBoardBg" class="btn">Выкл/Вкл фон</button>
      <button id="saveBoardSettings" class="btn primary">Сохранить</button>
    </div>
  </div>
</div>
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-main">
        <div class="footer-logo">
          <img src="../images/logo_youvi_ind_ex.png" alt="Youvi">
          <p>Платформа для общения и обсуждений. Делитесь мыслями и идеями.</p>
        </div>
        <div class="footer-sections">
          <div class="footer-section">
            <h3>Разделы</h3>
            <ul>
              <li><a href="../youvi_main.html">Видео</a></li>
              <li><a href="../youvi_tags.html">Теги</a></li>
              <li><a href="forum/forum.html" ">Форумы</a></li>
              <li><a href="../index.html">Управление</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3>Библиотека</h3>
            <ul>
              <li><a href="../youvi_ch_list.html">Каналы</a></li>
              <li><a href="../youvi_playlists_list.html">Плейлисты</a></li>
              <li><a href="../youvi_subscriptions.html">Подписки</a></li>
              <li><a href="../youvi_fav.html">Избранное</a></li>
              <li><a href="../youvi_history.html">История</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3>Wiki</h3>
            <ul>
              <li><a href="../wiki/index.html">Главная</a></li>
              <li><a href="../wiki/player.html">Плеер</a></li>
              <li><a href="../wiki/danmaku.html">Данмаку</a></li>
              <li><a href="../wiki/tags/general.html">Теги</a></li>
              <li><a href="../wiki/tags/rules.html">Правила тегирования</a></li>
              <li><a href="../wiki/search/general.html">Поиск</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3>PGC</h3>
            <ul>
              <li><a href="../youvi_main.html?tag=Anime (ct)">Anime</a></li>
              <li><a href="../youvi_main.html?tag=Animation (ct)">Animation</a></li>
              <li><a href="../youvi_main.html?tag=Movies (ct)">Movies</a></li>
              <li><a href="../youvi_main.html?tag=Series (ct)">Series</a></li>
              <li><a href="../youvi_main.html?tag=Music (ct)">Music</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3>UGC</h3>
            <ul>
              <li><a href="../youvi_main.html?tag=Games (ct)">Games</a></li>
              <li><a href="../youvi_main.html?tag=Technology (ct)">Technology</a></li>
              <li><a href="../youvi_main.html?tag=Entertainment (ct)">Entertainment</a></li>
              <li><a href="../youvi_main.html?tag=IRL (ct)">IRL</a></li>
              <li><a href="../youvi_main.html?tag=TV (ct)">TV</a></li>
              <li><a href="../youvi_main.html?tag=Education (ct)">Education</a></li>
              <li><a href="../youvi_main.html?tag=Other (ct)">Other</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h3>О сайте</h3>
            <ul>
              <li><a href="../wiki/about.html">Про сайт</a></li>
              <li><a href="../wiki/docs.html">Документация</a></li>
              <li><a href="../wiki/tech.html">Технологии</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="footer-right">
        <div class="footer-mascot">
          <img src="../images/mascot1.png" alt="Yuvi">
        </div>
      </div>
    </div>

  </footer>
<script>
// Use YouVi shared functions
let forumDirectoryHandle = null;
const boardId = new URLSearchParams(location.search).get('id');
let currentPage = 1;
const itemsPerPage = 20;

// Simplified caching with memory management
const CACHE_TTL_MS = 180000; // 3 minutes
const MAX_CACHE_SIZE = 100; // Maximum cached items per type
const MAX_MEMORY_MB = 50; // Rough memory limit

const caches = {
  counts: new Map(), // key: boardId, value: { at, count }
  directories: new Map(), // key: boardId, value: { at, entries }
  threadMeta: new Map() // key: boardId_threadId, value: { at, title, author, created, postCount }
};

// Request deduplication
const pendingRequests = new Map();

// Cache management
function cleanupCache(cache, maxSize = MAX_CACHE_SIZE) {
  if (cache.size <= maxSize) return;
  
  const entries = Array.from(cache.entries())
    .sort((a, b) => a[1].at - b[1].at); // Sort by age
  
  const toDelete = entries.slice(0, entries.length - maxSize);
  toDelete.forEach(([key]) => cache.delete(key));
}

function estimateMemoryUsage() {
  let totalSize = 0;
  for (const cache of Object.values(caches)) {
    for (const [key, value] of cache) {
      totalSize += JSON.stringify({key, value}).length * 2; // Rough UTF-16 estimate
    }
  }
  return totalSize / (1024 * 1024); // MB
}

function clearOldestCacheIfNeeded() {
  if (estimateMemoryUsage() > MAX_MEMORY_MB) {
    // Clear oldest entries from largest cache
    const cacheSizes = Object.entries(caches).map(([name, cache]) => [name, cache.size]);
    const [largestCacheName] = cacheSizes.sort((a, b) => b[1] - a[1])[0];
    cleanupCache(caches[largestCacheName], Math.floor(caches[largestCacheName].size * 0.7));
  }
}

function invalidateCache(boardId, threadId = null) {
  caches.counts.delete(boardId);
  caches.directories.delete(boardId);
  
  if (threadId) {
    caches.threadMeta.delete(`${boardId}_${threadId}`);
  } else {
    for (const key of caches.threadMeta.keys()) {
      if (key.startsWith(`${boardId}_`)) {
        caches.threadMeta.delete(key);
      }
    }
  }
}

// Request deduplication wrapper
async function dedupedRequest(key, requestFn) {
  if (pendingRequests.has(key)) {
    return pendingRequests.get(key);
  }
  
  const promise = requestFn().finally(() => {
    pendingRequests.delete(key);
  });
  
  pendingRequests.set(key, promise);
  return promise;
}

const BOARDS = {
  'general': { name: 'Общее', desc: '' },
  'images': { name: 'Картинки', desc: 'Обмен изображениями и артами' },
  'news': { name: 'Новости сайта', desc: 'Обновления и объявления' },
  'anime': { name: 'Аниме', desc: 'Аниме и манга' },
  'videogames': { name: 'Видеоигры', desc: 'Обсуждение игр' },
  'tv-and-cinema': { name: 'Кино и ТВ', desc: 'Фильмы и сериалы' },
  'music': { name: 'Музыка', desc: 'Музыка и музыканты' },
  '2d': { name: '2Д', desc: 'Рисование и 2D графика' },
  '3d': { name: '3Д', desc: '3D моделирование и анимация' },
  'worldbuilding': { name: 'Создание миров', desc: 'Worldbuilding и дизайн миров' },
  'tutorials': { name: 'Туториалы', desc: 'Обучающие материалы' },
  'creative-other': { name: 'Другое', desc: 'Прочее творчество' },
  'study': { name: 'Учёба', desc: 'Заметки про учебу' },
  'everyday': { name: 'Повседневность', desc: 'Разные жизненные мелочи' },
  'city': { name: 'Город', desc: 'Новости, история и будущее города' },
  'notes': { name: 'Заметки', desc: 'Личные заметки' },
  'technology': { name: 'Технологии', desc: 'Все что связано с технологиями' },
  'internet': { name: 'Интернет', desc: 'Сети и веб' },
  'gadgets': { name: 'Гаджеты', desc: 'Устройства и аксессуары' },
  'companies': { name: 'Компании', desc: 'Новости IT-компаний' }
};

// IndexedDB functions
async function openForumDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('8SiteDB', 1);
    request.onupgradeneeded = () => {
      const db = request.result;
      if (!db.objectStoreNames.contains('handles')) {
        db.createObjectStore('handles');
      }
    };
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

async function getFromForumDB(db, key) {
  return new Promise((resolve) => {
    const tx = db.transaction('handles', 'readonly');
    const store = tx.objectStore('handles');
    const request = store.get(key);
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => resolve(null);
  });
}

// File System functions
async function writeJSONFile(dirHandle, fileName, data) {
  try {
    const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
    const writable = await fileHandle.createWritable();
    await writable.write(JSON.stringify(data, null, 2));
    await writable.close();
  } catch (e) {
    console.error('Error writing file:', e);
  }
}

async function readJSONFile(dirHandle, fileName, defaultValue = null) {
  try {
    const fileHandle = await dirHandle.getFileHandle(fileName);
    const file = await fileHandle.getFile();
    const text = await file.text();
    return JSON.parse(text);
  } catch (e) {
    return defaultValue;
  }
}

async function saveImageFile(dirHandle, fileName, imageData) {
  try {
    const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
    const writable = await fileHandle.createWritable();
    await writable.write(new Uint8Array(imageData));
    await writable.close();
  } catch (e) {
    console.error('Error saving image:', e);
  }
}

async function createImageThumbnailFromFile(file, maxDim = 512) {
  try {
    const url = URL.createObjectURL(file);
    const img = await new Promise((resolve, reject) => {
      const i = new Image();
      i.onload = () => resolve(i);
      i.onerror = reject;
      i.src = url;
    });
    
    const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
    const w = Math.max(1, Math.round(img.width * scale));
    const h = Math.max(1, Math.round(img.height * scale));
    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    
    const ctx = canvas.getContext('2d');
    if (!ctx) return null;
    
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(img, 0, 0, w, h);
    
    const blob = await new Promise(res => canvas.toBlob(b => res(b), 'image/jpeg', 0.85));
    URL.revokeObjectURL(url);
    return blob;
  } catch (_) {
    return null;
  }
}

// Optimized directory listing with async iteration
async function getDirectoryEntries(boardId) {
  const cacheKey = boardId;
  const cached = caches.directories.get(cacheKey);
  
  if (cached && (Date.now() - cached.at) < CACHE_TTL_MS) {
    return cached.entries;
  }

  return dedupedRequest(`dir_${boardId}`, async () => {
    try {
      const boardDir = await forumDirectoryHandle.getDirectoryHandle(boardId);
      const entries = [];
      
      // Use async iteration in chunks to avoid blocking
      let processedCount = 0;
      for await (const [threadName, handle] of boardDir.entries()) {
        if (handle.kind !== 'directory') continue;
        if (threadName === 'assets' || threadName.startsWith('.')) continue;
        
        entries.push(threadName);
        
        // Yield control every 20 entries
        if (++processedCount % 20 === 0) {
          await new Promise(resolve => setTimeout(resolve, 0));
        }
      }
      
      // Sort by timestamp (newest first)
      entries.sort((a, b) => (parseInt(b) || 0) - (parseInt(a) || 0));
      
      cleanupCache(caches.directories);
      caches.directories.set(cacheKey, { at: Date.now(), entries });
      clearOldestCacheIfNeeded();
      
      return entries;
    } catch (e) {
      console.error('Error getting directory entries:', e);
      return [];
    }
  });
}

async function getThreadsCount() {
  if (!forumDirectoryHandle || !boardId) return 0;
  
  const cached = caches.counts.get(boardId);
  if (cached && (Date.now() - cached.at) < CACHE_TTL_MS) {
    return cached.count;
  }
  
  return dedupedRequest(`count_${boardId}`, async () => {
    const entries = await getDirectoryEntries(boardId);
    const count = entries.length;
    
    cleanupCache(caches.counts);
    caches.counts.set(boardId, { at: Date.now(), count });
    
    return count;
  });
}

// Lightweight thread metadata (no full content)
async function getThreadMetadata(boardId, threadId, isPinned = false) {
  const cacheKey = `${boardId}_${threadId}`;
  const cached = caches.threadMeta.get(cacheKey);
  
  if (cached && (Date.now() - cached.at) < CACHE_TTL_MS) {
    cached.pinned = isPinned;
    return cached;
  }
  
  return dedupedRequest(cacheKey, async () => {
    try {
      const boardDir = await forumDirectoryHandle.getDirectoryHandle(boardId);
      const threadDir = await boardDir.getDirectoryHandle(threadId);
      const jsonHandle = await threadDir.getFileHandle('thread.json');
      const file = await jsonHandle.getFile();
      const text = await file.text();
      
      let threadData;
      try {
        threadData = JSON.parse(text);
      } catch (_) {
        threadData = {
          id: threadId,
          title: 'Без названия',
          author: 'Аноним',
          created: Date.now(),
          posts: []
        };
      }
      
      // Store only essential metadata to reduce memory usage
      const metadata = {
        id: threadId,
        title: threadData.title,
        author: threadData.author,
        created: threadData.created,
        postCount: threadData.posts ? threadData.posts.length : 0,
        lastPostDate: threadData.lastPostDate || file.lastModified,
        lastPost: threadData.posts && threadData.posts.length > 0 ? 
          {
            nick: threadData.posts[threadData.posts.length - 1].nick,
            date: threadData.posts[threadData.posts.length - 1].date
          } : null,
        pinned: isPinned,
        at: Date.now()
      };
      
      cleanupCache(caches.threadMeta);
      caches.threadMeta.set(cacheKey, metadata);
      clearOldestCacheIfNeeded();
      
      return metadata;
    } catch (e) {
      console.error(`Error getting thread metadata for ${threadId}:`, e);
      return null;
    }
  });
}

async function getPinnedThreads() {
  try {
    const boardDir = await forumDirectoryHandle.getDirectoryHandle(boardId);
    const boardData = await readJSONFile(boardDir, 'board.json', {});
    return boardData.pinnedThreads || [];
  } catch (e) {
    return [];
  }
}

async function getThreadsPage(page) {
  if (!forumDirectoryHandle || !boardId) return [];
  
  return dedupedRequest(`page_${boardId}_${page}`, async () => {
    const entries = await getDirectoryEntries(boardId);
    if (entries.length === 0) return [];
    
    const startIndex = (page - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageEntries = entries.slice(startIndex, endIndex);
    
    // Batch load metadata in chunks of 5 to avoid overwhelming the filesystem
    const results = [];
    for (let i = 0; i < pageEntries.length; i += 5) {
      const chunk = pageEntries.slice(i, i + 5);
      const chunkPromises = chunk.map(threadId => getThreadMetadata(boardId, threadId));
      const chunkResults = await Promise.all(chunkPromises);
      results.push(...chunkResults.filter(Boolean));
      
      // Small delay between chunks
      if (i + 5 < pageEntries.length) {
        await new Promise(resolve => setTimeout(resolve, 10));
      }
    }
    
    return results.sort((a, b) => (b.lastPostDate || 0) - (a.lastPostDate || 0));
  });
}

// Background preloading with proper timing
let preloadTimeout = null;
async function schedulePreload() {
  if (preloadTimeout) clearTimeout(preloadTimeout);
  
  // Wait for user interaction to settle before preloading
  preloadTimeout = setTimeout(async () => {
    if (!forumDirectoryHandle || !boardId) return;
    
    try {
      const totalCount = await getThreadsCount();
      const totalPages = Math.ceil(totalCount / itemsPerPage);
      
      if (currentPage < totalPages) {
        // Preload next page metadata only
        await getThreadsPage(currentPage + 1);
      }
    } catch (e) {
      console.error('Preload error:', e);
    }
  }, 500); // Wait 500ms for user interaction to settle
}

async function createThread() {
  if (!forumDirectoryHandle) {
    alert('Выберите папку на index.html');
    return;
  }
  
  const nick = document.getElementById('nickInput').value.trim() || 'Аноним';
  const title = document.getElementById('titleInput').value.trim();
  const message = document.getElementById('messageInput').value.trim();
  const file = document.getElementById('imageInput').files[0];
  
  if (!title || !message) {
    alert('Введите тему и сообщение');
    return;
  }
  
  if (file && file.size > 5 * 1024 * 1024) {
    alert('Файл слишком большой (максимум 5MB)');
    return;
  }
  
  try {
    localStorage.setItem('forumNick', nick);
    
    const threadId = Date.now().toString();
    const boardDir = await forumDirectoryHandle.getDirectoryHandle(boardId);
    const threadDir = await boardDir.getDirectoryHandle(threadId, { create: true });
    const imagesDir = await threadDir.getDirectoryHandle('images', { create: true });
    
    let imageFileName = null;
    let imageThumbFileName = null;
    
    if (file) {
      imageFileName = `${Date.now()}_${file.name}`;
      const imageData = Array.from(new Uint8Array(await file.arrayBuffer()));
      await saveImageFile(imagesDir, imageFileName, imageData);
      
      try {
        const thumbBlob = await createImageThumbnailFromFile(file, 512);
        if (thumbBlob) {
          imageThumbFileName = `thumb_${Date.now()}.jpg`;
          const tfh = await imagesDir.getFileHandle(imageThumbFileName, { create: true });
          const tw = await tfh.createWritable();
          await tw.write(new Uint8Array(await thumbBlob.arrayBuffer()));
          await tw.close();
        }
      } catch (_) {}
    }
    
    const post = {
      nick,
      text: message,
      date: Date.now(),
      imageFileName,
      imageThumbFileName
    };
    
    const threadData = {
      id: threadId,
      title,
      author: nick,
      created: Date.now(),
      lastPostDate: Date.now(),
      posts: [post]
    };
    
    await writeJSONFile(threadDir, 'thread.json', threadData);
    
    // Clear form
    document.getElementById('titleInput').value = '';
    document.getElementById('messageInput').value = '';
    document.getElementById('imageInput').value = '';
    
    // Update user profile using YouVi integration
    try {
      await window.ForumYouViIntegration.incrementForumPostCount(nick);
    } catch (e) {
      console.error('Error updating user stats:', e);
    }
    
    // Invalidate caches and refresh
    invalidateCache(boardId);
    render(true);
  } catch (e) {
    console.error('Error creating thread:', e);
    alert('Ошибка создания темы');
  }
}

async function deleteThread(threadId) {
  if (!confirm('Удалить тему?')) return;
  if (!forumDirectoryHandle) return;
  
  try {
    const boardDir = await forumDirectoryHandle.getDirectoryHandle(boardId);
    
    // Get thread data before deletion for search index cleanup
    let threadData = null;
    try {
      const threadDir = await boardDir.getDirectoryHandle(threadId);
      const jsonHandle = await threadDir.getFileHandle('thread.json');
      const file = await jsonHandle.getFile();
      const text = await file.text();
      threadData = JSON.parse(text);
    } catch (e) {
      console.warn('Could not read thread data before deletion:', e);
    }
    
    // Delete the thread directory
    await boardDir.removeEntry(threadId, { recursive: true });
    
    // Notify search engine about deletion
    if (threadData && window.searchEngine) {
      const fileData = {
        type: 'forum',
        name: `thread_${threadId}.json`,
        fileName: `thread_${threadId}.json`,
        title: threadData.title || 'Без названия',
        content: threadData.posts ? threadData.posts.map(p => p.text).join(' ') : '',
        path: `forum/${boardId}`,
        board: boardId,
        threadId: threadId,
        author: threadData.author || 'Аноним',
        postsCount: threadData.posts ? threadData.posts.length : 0
      };
      
      try {
        await window.searchEngine.notifyFileDeleted(fileData);
        console.log('Notified search engine about thread deletion');
      } catch (e) {
        console.warn('Failed to notify search engine:', e);
      }
    }
    
    invalidateCache(boardId, threadId);
    render(true);
  } catch (e) {
    console.error('Error deleting thread:', e);
    alert('Ошибка удаления темы');
  }
}

function createPagination(totalPages, totalItems) {
  const existing = document.getElementById('pagination');
  if (existing) existing.remove();
  if (totalPages <= 1) return;
  
  const pagination = document.createElement('div');
  pagination.id = 'pagination';
  pagination.className = 'pagination';
  
  const info = document.createElement('div');
  info.className = 'pagination-info';
  const startItem = (currentPage - 1) * itemsPerPage + 1;
  const endItem = Math.min(currentPage * itemsPerPage, totalItems);
  info.textContent = `${startItem}-${endItem} из ${totalItems} (стр. ${currentPage} из ${totalPages})`;
  pagination.appendChild(info);
  
  function pageBtn(text, page) {
    const b = document.createElement('button');
    b.className = 'pagination-btn';
    b.textContent = text;
    b.addEventListener('click', () => {
      currentPage = page;
      render(true);
    });
    return b;
  }
  
  if (currentPage > 1) pagination.appendChild(pageBtn('‹ Назад', currentPage - 1));
  
  const maxVisible = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
  let endPage = Math.min(totalPages, startPage + maxVisible - 1);
  if (endPage - startPage + 1 < maxVisible) startPage = Math.max(1, endPage - maxVisible + 1);
  
  if (startPage > 1) {
    pagination.appendChild(pageBtn('1', 1));
    if (startPage > 2) {
      const dots = document.createElement('span');
      dots.textContent = '...';
      dots.style.cssText = 'margin:0 5px;color:#999;';
      pagination.appendChild(dots);
    }
  }
  
  for (let i = startPage; i <= endPage; i++) {
    const btn = pageBtn(i.toString(), i);
    if (i === currentPage) btn.classList.add('active');
    pagination.appendChild(btn);
  }
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      const dots = document.createElement('span');
      dots.textContent = '...';
      dots.style.cssText = 'margin:0 5px;color:#999;';
      pagination.appendChild(dots);
    }
    pagination.appendChild(pageBtn(totalPages.toString(), totalPages));
  }
  
  if (currentPage < totalPages) pagination.appendChild(pageBtn('Вперед ›', currentPage + 1));
  
  const section = document.getElementById('threadsList')?.closest('section');
  if (section) section.appendChild(pagination);
}

function showLoadingState() {
  const list = document.getElementById('threadsList');
  if (!list) return;
  
  list.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:center;padding:40px;color:#666;">
      <div style="width:20px;height:20px;border:2px solid #f3f3f3;border-top:2px solid #ff69b4;border-radius:50%;animation:spin 1s linear infinite;margin-right:10px;"></div>
      Загрузка...
    </div>
  `;
}

async function render(showLoading = false) {
  let board = BOARDS[boardId];
  if (!board) {
    try {
      const customBoards = await readJSONFile(forumDirectoryHandle, 'custom_boards.json', []);
      const found = customBoards.find(b => b.id === boardId);
      if (found) {
        board = { name: found.name || found.id, desc: found.desc || '' };
      }
    } catch (e) {}
  }
  
  if (!board) {
    document.body.innerHTML = '<div style="padding:20px;text-align:center;">Раздел не найден</div>';
    return;
  }
  
  if (showLoading) {
    showLoadingState();
  }
  
  // Apply theme/background from board.json if exists
  try {
    const boardDir = await forumDirectoryHandle.getDirectoryHandle(boardId);
    const boardData = await readJSONFile(boardDir, 'board.json', null);
    if (boardData) {
      const customizationDisabled = localStorage.getItem('disableForumCustomization') === 'true';
      const themeClasses = ['theme-lime', 'theme-red', 'theme-gold', 'theme-cyan', 'theme-aqua', 'theme-purple', 'theme-darkblue', 'theme-cherry', 'theme-orange'];
      document.body.classList.remove(...themeClasses);
      
      if (!customizationDisabled && boardData.theme && boardData.theme !== 'default') {
        document.body.classList.add(boardData.theme);
      }
      
      if (!customizationDisabled && boardData.background && boardData.backgroundEnabled !== false) {
        try {
          const bgPath = boardData.background;
          const parts = bgPath.split('/');
          let dir = boardDir;
          for (let i = 0; i < parts.length - 1; i++) {
            dir = await dir.getDirectoryHandle(parts[i]);
          }
          const fh = await dir.getFileHandle(parts[parts.length - 1]);
          const file = await fh.getFile();
          const url = URL.createObjectURL(file);
          // Use CSS variable approach like channel feed
          document.body.style.setProperty('--bg-image', `url(${url})`);
          document.body.classList.add('custom-background');
        } catch (_) {
          document.body.style.removeProperty('--bg-image');
          document.body.classList.remove('custom-background');
        }
      } else {
        document.body.style.removeProperty('--bg-image');
        document.body.classList.remove('custom-background');
      }
      
      try {
        const tBtn = document.getElementById('toggleBoardBg');
        if (tBtn) {
          const isEnabled = boardData.backgroundEnabled !== false;
          tBtn.textContent = isEnabled ? 'Выключить фон' : 'Включить фон';
        }
      } catch (_) {}
      
      try {
        updateHeaderLogoBasedOnTheme();
      } catch (_) {}
    }
  } catch (_) {}
  
  document.getElementById('boardTitle').textContent = board.name;
  document.getElementById('boardBreadcrumb').textContent = board.name;
  document.getElementById('boardInfo').textContent = board.desc;
  
  // Update page title
  document.title = `${board.name} | Youvi Forums`;
  
  const list = document.getElementById('threadsList');
  
  if (!forumDirectoryHandle) {
    list.innerHTML = '<div style="padding:14px 16px;color:#666;text-align:center">Выберите папку на <a href="../index.html">index.html</a></div>';
    return;
  }
  
  const totalItems = await getThreadsCount();
  const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
  if (currentPage > totalPages) currentPage = totalPages;
  
  // Get pinned threads
  const pinnedIds = await getPinnedThreads();
  const pinnedThreads = [];
  
  for (const threadId of pinnedIds) {
    const meta = await getThreadMetadata(boardId, threadId, true);
    if (meta) pinnedThreads.push(meta);
  }
  
  const threads = await getThreadsPage(currentPage);
  
  if (totalItems === 0) {
    list.innerHTML = '<div style="padding:14px 16px;color:#666;text-align:center">Нет тем. Создайте первую!</div>';
    return;
  }
  
  // Single DOM update with document fragment
  const fragment = document.createDocumentFragment();
  
  // Render pinned threads first (only on page 1)
  if (currentPage === 1) {
    for (const thread of pinnedThreads) {
      fragment.appendChild(createThreadRow(thread, true));
    }
  }
  
  // Render regular threads
  for (const thread of threads) {
    // Skip if already shown as pinned
    if (pinnedIds.includes(thread.id)) continue;
    fragment.appendChild(createThreadRow(thread, false));
  }
  
  list.innerHTML = '';
  list.appendChild(fragment);
  createPagination(totalPages, totalItems);
  
  // Schedule background preloading
  schedulePreload();
}

function createThreadRow(thread, isPinned) {
  const lastPost = thread.lastPost;
  const replyPrefix = thread.postCount > 1 ? 'Re: ' : '';
  const row = document.createElement('a');
  row.className = isPinned ? 'board-item pinned' : 'board-item';
  row.href = `forum_thread.html?board=${boardId}&id=${thread.id}`;
  
  const lastAuthorNick = lastPost ? (lastPost.nick || 'Аноним') : '';
  const profileHref = lastPost ? `forum_profile.html?nick=${encodeURIComponent((lastAuthorNick || '').toLowerCase().replace(/\s+/g, '_'))}` : '#';
  const lastPostHtml = lastPost ? `
    <div class="last-post-title"><a href="forum_thread.html?board=${boardId}&id=${thread.id}&highlight=last" style="color:inherit;text-decoration:none">${replyPrefix}${escapeHtml(thread.title)}</a></div>
    <div class="last-post-author">от <a href="${profileHref}">${escapeHtml(lastAuthorNick)}</a></div>
    <div class="last-post-time">${new Date(thread.lastPostDate).toLocaleString()}</div>
  ` : 'Нет активности';
  
  row.innerHTML = `
    <div class="board-info">
      <div>
        <div class="board-title">${escapeHtml(thread.title)}</div>
        <div class="board-description">Автор: <a href="forum_profile.html?nick=${encodeURIComponent((thread.author || '').toLowerCase().replace(/\s+/g, '_'))}">${escapeHtml(thread.author)}</a> • Создан: ${new Date(thread.created).toLocaleString()}</div>
      </div>
    </div>
    <div class="posts-stats">${thread.postCount}</div>
    <div class="last-post">${lastPostHtml}</div>
    <div style="text-align:center;display:flex;gap:4px;justify-content:center">
      <button class="small-btn btn" onclick="event.preventDefault(); togglePinThread('${thread.id}')">${isPinned ? 'Откр' : 'Закр'}</button>
      <button class="small-btn btn" onclick="event.preventDefault(); deleteThread('${thread.id}')">×</button>
    </div>
  `;
  return row;
}

async function togglePinThread(threadId) {
  try {
    const boardDir = await forumDirectoryHandle.getDirectoryHandle(boardId);
    let boardData = await readJSONFile(boardDir, 'board.json', {});
    
    if (!boardData.pinnedThreads) {
      boardData.pinnedThreads = [];
    }
    
    const index = boardData.pinnedThreads.indexOf(threadId);
    if (index > -1) {
      // Unpin
      boardData.pinnedThreads.splice(index, 1);
    } else {
      // Pin (add to beginning)
      boardData.pinnedThreads.unshift(threadId);
    }
    
    await writeJSONFile(boardDir, 'board.json', boardData);
    invalidateCache(boardId);
    await render(false);
  } catch (e) {
    console.error('Error toggling pin:', e);
    alert('Не удалось закрепить/открепить тему');
  }
}

function escapeHtml(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// Initialize
const nickInput = document.getElementById('nickInput');
nickInput.value = localStorage.getItem('forumNick') || '';

document.getElementById('createThread').onclick = createThread;
document.getElementById('resetCreate').addEventListener('click', () => {
  document.getElementById('titleInput').value = '';
  document.getElementById('messageInput').value = '';
  document.getElementById('imageInput').value = '';
});

document.querySelector('.logo').addEventListener('click', () => {
  location.href = 'forum.html';
});

// Load directory handle and render
// Initialize - get forum directory from YouVi
(async () => {
  try {
    forumDirectoryHandle = await window.YouviShared.getForumDirectory();
    
    if (!forumDirectoryHandle) {
      console.warn('No YouVi directory selected. Please select folder on index.html');
    }
  } catch (e) {
    console.error('Error loading forum directory:', e);
  }
  
  render(true);
})();

// Make functions global
window.deleteThread = deleteThread;

// Settings popover logic
const settingsPopover = document.getElementById('boardSettingsPopover');
const settingsBtn = document.getElementById('openBoardSettings');

function openPopover() {
  settingsPopover.style.display = 'block';
  settingsPopover.style.visibility = 'hidden';
  const rect = settingsBtn.getBoundingClientRect();
  const popRect = settingsPopover.getBoundingClientRect();
  const top = rect.top + window.scrollY - popRect.height - 8;
  const left = rect.left + window.scrollX + rect.width - popRect.width;
  settingsPopover.style.top = Math.max(10, top) + 'px';
  settingsPopover.style.left = Math.max(10, left) + 'px';
  settingsPopover.style.visibility = 'visible';
}

function closePopover() {
  settingsPopover.style.display = 'none';
}

settingsBtn.addEventListener('click', (e) => {
  e.preventDefault();
  if (settingsPopover.style.display === 'block') {
    closePopover();
  } else {
    openPopover();
  }
});

document.getElementById('closeBoardSettings').addEventListener('click', (e) => {
  e.preventDefault();
  closePopover();
});

document.addEventListener('click', (e) => {
  if (!settingsPopover.contains(e.target) && e.target !== settingsBtn) {
    closePopover();
  }
}, true);

// Collapse/expand create thread panel
(function initCreateThreadCollapse() {
  try {
    const btn = document.getElementById('toggleCreateThread');
    const panel = document.getElementById('createThreadPanel');
    if (!panel || !btn) return;
    
    const stored = localStorage.getItem('forum_create_collapsed');
    const shouldCollapse = stored ? (stored === 'true') : true;
    if (shouldCollapse) panel.classList.add('collapsed');
    
    const syncBtn = () => {
      const isCollapsed = panel.classList.contains('collapsed');
      btn.setAttribute('aria-expanded', String(!isCollapsed));
      btn.textContent = isCollapsed ? 'Новая тема ▸' : 'Новая тема ▾';
    };
    
    syncBtn();
    
    const toggle = (e) => {
      if (e) e.preventDefault();
      panel.classList.toggle('collapsed');
      localStorage.setItem('forum_create_collapsed', String(panel.classList.contains('collapsed')));
      syncBtn();
    };
    
    btn.addEventListener('click', toggle);
    panel.querySelector('.thread-create-header')?.addEventListener('click', toggle);
  } catch (_) {}
})();

// Save background settings
document.getElementById('saveBoardSettings').addEventListener('click', async () => {
  try {
    const fileInput = document.getElementById('boardBgFile');
    const boardDir = await forumDirectoryHandle.getDirectoryHandle(boardId);
    let boardData = await readJSONFile(boardDir, 'board.json', {});
    
    if (fileInput.files && fileInput.files[0]) {
      const assetsDir = await boardDir.getDirectoryHandle('assets', { create: true });
      const file = fileInput.files[0];
      const bgFileName = 'background_' + Date.now() + '_' + file.name;
      const fh = await assetsDir.getFileHandle(bgFileName, { create: true });
      const w = await fh.createWritable();
      await w.write(new Uint8Array(await file.arrayBuffer()));
      await w.close();
      boardData.background = 'assets/' + bgFileName;
      boardData.backgroundEnabled = true;
    }
    
    await writeJSONFile(boardDir, 'board.json', boardData);
    closePopover();
    render(false);
  } catch (e) {
    alert('Не удалось сохранить оформление раздела');
  }
});

// Toggle board background
document.getElementById('toggleBoardBg').addEventListener('click', async () => {
  try {
    const boardDir = await forumDirectoryHandle.getDirectoryHandle(boardId);
    let boardData = await readJSONFile(boardDir, 'board.json', {});
    const current = boardData.backgroundEnabled !== false;
    boardData.backgroundEnabled = !current;
    await writeJSONFile(boardDir, 'board.json', boardData);
    render(false);
  } catch (_) {
    alert('Не удалось переключить фон');
  }
});

// Auto-load static banner per board
(async function loadStaticBoardBanner() {
  try {
    const bannerEl = document.getElementById('forumBannerSection');
    if (!bannerEl) return;
    
    // Устанавливаем board_banner.png
    bannerEl.style.backgroundImage = `url('../images/banners/board_banner.png')`;
    
    // Добавляем название доски на баннер
    const boardInfo = BOARDS[boardId];
    if (boardInfo && boardInfo.name) {
      const nameOverlay = document.createElement('div');
      nameOverlay.className = 'board-name-overlay';
      nameOverlay.textContent = boardInfo.name;
      bannerEl.appendChild(nameOverlay);
    }
    
    // Добавляем логотип справа
    const logo = document.createElement('img');
    logo.className = 'board-logo';
    logo.src = '../images/youvi_icon.png';
    logo.alt = 'Youvi';
    bannerEl.appendChild(logo);
  } catch (e) {
    const bannerEl = document.getElementById('forumBannerSection');
    if (bannerEl) {
      bannerEl.style.backgroundImage = "url('../images/banners/board_banner.png')";
    }
  }
})();

// Header logo switcher based on theme
function updateHeaderLogoBasedOnTheme() {
  try {
    const img = document.getElementById('siteLogo');
    if (!img) return;
    
    const themeMap = {
      'theme-lime': 'images/logo_lime.png',
      'theme-red': 'images/logo_red.png',
      'theme-gold': 'images/logo_gold.png',
      'theme-cyan': 'images/logo_cyan.png',
      'theme-purple': 'images/logo_purple.png',
      'theme-cherry': 'images/logo_cherry.png',
      'theme-darkblue': 'images/logo_darkblue.png',
      'theme-aqua': 'images/logo_aqua.png',
      'theme-orange': 'images/logo_orange.png',
      'default': 'images/logo_default.png'
    };
    
    let chosen = themeMap['default'];
    for (const cls of Object.keys(themeMap)) {
      if (cls !== 'default' && document.body.classList.contains(cls)) {
        chosen = themeMap[cls];
        break;
      }
    }
    img.src = chosen;
  } catch (e) {}
}

updateHeaderLogoBasedOnTheme();

// Header search functionality
const headerSearchBtn = document.getElementById('forumHeaderSearchBtn');
const headerSearchInput = document.getElementById('forumHeaderSearchInput');

if (headerSearchBtn && headerSearchInput) {
  headerSearchBtn.addEventListener('click', () => {
    const query = headerSearchInput.value.trim();
    if (query) {
      window.location.href = `forum_search.html?q=${encodeURIComponent(query)}`;
    }
  });
  
  headerSearchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      const query = headerSearchInput.value.trim();
      if (query) {
        window.location.href = `forum_search.html?q=${encodeURIComponent(query)}`;
      }
    }
  });
}

// Theme system is handled by theme-toggle.js

</script>

<script src="../youvi/sidebar-toggle.js"></script>
<script src="../youvi/sidebar-scroll.js"></script>
<script src="../youvi/header/youvi-header.js"></script>

</body>
</html>