<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>–ú–∏–≥—Ä–∞—Ü–∏—è —Ñ–æ—Ä—É–º–∞ –≤ YouVi</title>
<style>
body{font-family:Arial,sans-serif;max-width:800px;margin:40px auto;padding:20px;background:#f5f5f5}
.container{background:#fff;padding:30px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
h1{color:#d94b88;margin-bottom:20px}
.step{margin:20px 0;padding:15px;background:#f9f9f9;border-left:4px solid #ff69b4;border-radius:4px}
.step h3{margin:0 0 10px 0;color:#333}
.step p{margin:5px 0;color:#666;font-size:14px}
button{background:#ff69b4;color:#fff;border:none;padding:12px 24px;border-radius:4px;cursor:pointer;font-size:14px;font-weight:600;margin:10px 5px 0 0}
button:hover{background:#e91e63}
button:disabled{background:#ccc;cursor:not-allowed}
.log{margin-top:20px;padding:15px;background:#f0f0f0;border-radius:4px;font-family:monospace;font-size:12px;max-height:300px;overflow-y:auto;white-space:pre-wrap}
.success{color:#4caf50;font-weight:600}
.error{color:#f44336;font-weight:600}
.warning{color:#ff9800;font-weight:600}
</style>
</head>
<body>
<div class="container">
  <h1>üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Ñ–æ—Ä—É–º–∞ –≤ YouVi</h1>
  
  <div class="step">
    <h3>–®–∞–≥ 1: –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É YouVi</h3>
    <p>–í—ã–±–µ—Ä–∏—Ç–µ –≥–ª–∞–≤–Ω—É—é –ø–∞–ø–∫—É —Å –≤–∏–¥–µ–æ (–≥–¥–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ forum)</p>
    <button id="selectFolder">–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É</button>
    <p id="folderStatus" style="margin-top:10px"></p>
  </div>
  
  <div class="step">
    <h3>–®–∞–≥ 2: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö</h3>
    <p>–ü–µ—Ä–µ–Ω–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ forum/users –≤ .channels</p>
    <button id="migrateBtn" disabled>–ù–∞—á–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é</button>
  </div>
  
  <div id="logContainer" style="display:none">
    <h3>–õ–æ–≥ –º–∏–≥—Ä–∞—Ü–∏–∏:</h3>
    <div class="log" id="log"></div>
  </div>
</div>

<script src="../youvi_shared.js"></script>
<script>
'use strict';

const { 
  openYouviDB, 
  getFromYouviDB, 
  saveToYouviDB,
  getYouviDirectory,
  getForumDirectory,
  getChannelsDirectory,
  readJSONFile,
  writeJSONFile,
  saveUserProfile
} = window.YouviShared || {};

let youviDirHandle = null;
const logEl = document.getElementById('log');
const logContainer = document.getElementById('logContainer');

function log(msg, type = 'info') {
  const timestamp = new Date().toLocaleTimeString();
  const prefix = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : type === 'warning' ? '‚ö†' : '‚Ñπ';
  logEl.innerHTML += `<span class="${type}">[${timestamp}] ${prefix} ${msg}</span>\n`;
  logEl.scrollTop = logEl.scrollHeight;
  console.log(`[${type}] ${msg}`);
}

document.getElementById('selectFolder').addEventListener('click', async () => {
  try {
    youviDirHandle = await window.showDirectoryPicker();
    const db = await openYouviDB();
    await saveToYouviDB(db, 'videoDirectoryHandle', youviDirHandle);
    
    document.getElementById('folderStatus').innerHTML = `<span class="success">‚úì –í—ã–±—Ä–∞–Ω–∞ –ø–∞–ø–∫–∞: ${youviDirHandle.name}</span>`;
    document.getElementById('migrateBtn').disabled = false;
    log(`–ü–∞–ø–∫–∞ –≤—ã–±—Ä–∞–Ω–∞: ${youviDirHandle.name}`, 'success');
  } catch (e) {
    document.getElementById('folderStatus').innerHTML = `<span class="error">‚úó –û—à–∏–±–∫–∞: ${e.message}</span>`;
    log(`–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–∞–ø–∫–∏: ${e.message}`, 'error');
  }
});

document.getElementById('migrateBtn').addEventListener('click', async () => {
  logContainer.style.display = 'block';
  document.getElementById('migrateBtn').disabled = true;
  
  try {
    log('–ù–∞—á–∞–ª–æ –º–∏–≥—Ä–∞—Ü–∏–∏...', 'info');
    
    // Get directories
    const forumDir = await getForumDirectory();
    if (!forumDir) {
      log('–ü–∞–ø–∫–∞ forum –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞—é...', 'warning');
    }
    
    const channelsDir = await getChannelsDirectory();
    log('–ü–∞–ø–∫–∞ .channels –≥–æ—Ç–æ–≤–∞', 'success');
    
    // Check if old users directory exists
    let usersDir;
    try {
      usersDir = await forumDir.getDirectoryHandle('users', { create: false });
      log('–ù–∞–π–¥–µ–Ω–∞ –ø–∞–ø–∫–∞ forum/users', 'info');
    } catch (e) {
      log('–ü–∞–ø–∫–∞ forum/users –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ - –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è', 'warning');
      log('–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
      return;
    }
    
    // Migrate users
    let migratedCount = 0;
    let skippedCount = 0;
    let errorCount = 0;
    
    for await (const [userName, handle] of usersDir.entries()) {
      if (handle.kind !== 'directory' || userName.startsWith('.')) {
        continue;
      }
      
      try {
        log(`–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userName}`, 'info');
        
        // Read old profile
        const oldProfile = await readJSONFile(handle, 'profile.json', {});
        
        // Check if user already exists in channels
        let userChannelDir;
        try {
          userChannelDir = await channelsDir.getDirectoryHandle(userName, { create: false });
          const existingProfile = await readJSONFile(userChannelDir, 'channel.json', null);
          if (existingProfile) {
            log(`  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userName} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ .channels, –ø—Ä–æ–ø—É—Å–∫–∞—é`, 'warning');
            skippedCount++;
            continue;
          }
        } catch (e) {
          // User doesn't exist, create
          userChannelDir = await channelsDir.getDirectoryHandle(userName, { create: true });
        }
        
        // Convert profile.json to channel.json format
        const channelData = {
          name: userName,
          description: oldProfile.bio || oldProfile.description || '',
          avatar: oldProfile.avatarFileName || oldProfile.avatarThumbFileName || null,
          stats: {
            videos: 0,
            forumPosts: oldProfile.postsCount || 0
          },
          joinedAt: oldProfile.joinedAt || Date.now(),
          forumBio: oldProfile.bio || ''
        };
        
        await writeJSONFile(userChannelDir, 'channel.json', channelData);
        log(`  ‚úì –°–æ–∑–¥–∞–Ω channel.json –¥–ª—è ${userName}`, 'success');
        
        // Copy avatar if exists
        if (oldProfile.avatarFileName) {
          try {
            const avatarHandle = await handle.getFileHandle(oldProfile.avatarFileName);
            const avatarFile = await avatarHandle.getFile();
            const avatarBuffer = await avatarFile.arrayBuffer();
            
            const newAvatarHandle = await userChannelDir.getFileHandle(oldProfile.avatarFileName, { create: true });
            const writable = await newAvatarHandle.createWritable();
            await writable.write(avatarBuffer);
            await writable.close();
            
            log(`  ‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫–∞ –¥–ª—è ${userName}`, 'success');
          } catch (e) {
            log(`  ‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É: ${e.message}`, 'warning');
          }
        }
        
        // Copy thumbnail if exists and different from avatar
        if (oldProfile.avatarThumbFileName && oldProfile.avatarThumbFileName !== oldProfile.avatarFileName) {
          try {
            const thumbHandle = await handle.getFileHandle(oldProfile.avatarThumbFileName);
            const thumbFile = await thumbHandle.getFile();
            const thumbBuffer = await thumbFile.arrayBuffer();
            
            const newThumbHandle = await userChannelDir.getFileHandle(oldProfile.avatarThumbFileName, { create: true });
            const writable = await newThumbHandle.createWritable();
            await writable.write(thumbBuffer);
            await writable.close();
            
            log(`  ‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –º–∏–Ω–∏–∞—Ç—é—Ä–∞ –¥–ª—è ${userName}`, 'success');
          } catch (e) {
            log(`  ‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –º–∏–Ω–∏–∞—Ç—é—Ä—É: ${e.message}`, 'warning');
          }
        }
        
        migratedCount++;
        log(`  ‚úì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userName} —É—Å–ø–µ—à–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω`, 'success');
        
      } catch (e) {
        errorCount++;
        log(`  ‚úó –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ ${userName}: ${e.message}`, 'error');
      }
    }
    
    log('', 'info');
    log('=== –ò–¢–û–ì–ò –ú–ò–ì–†–ê–¶–ò–ò ===', 'info');
    log(`–£—Å–ø–µ—à–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${migratedCount}`, 'success');
    log(`–ü—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç): ${skippedCount}`, 'warning');
    log(`–û—à–∏–±–æ–∫: ${errorCount}`, errorCount > 0 ? 'error' : 'info');
    log('', 'info');
    log('–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', 'success');
    log('–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É forum/users –≤—Ä—É—á–Ω—É—é', 'info');
    
  } catch (e) {
    log(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${e.message}`, 'error');
    console.error(e);
  }
});
</script>
</body>
</html>
